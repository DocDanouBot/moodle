import{call as fetchMany}from"core/ajax";import MoodleConfig from"core/config";import{addIconToContainer}from"core/loadingicon";import Notification from"core/notification";import Pending from"core/pending";import{get_string as getString}from"core/str";import{render as renderTemplate}from"core/templates";import{replaceNode}from"core/templates";const SELECTORS={addGradeItemButton:"#mod_quiz-add_grade_item",autoSetupButton:"#mod_quiz-grades_auto_setup",editingPageContents:"#edit_grading_page-contents",gradeItemList:"table#mod_quiz-grade-item-list",gradeItemSelect:"select[data-slot-id]",gradeItemSelectId:id=>"select#grade-item-choice-"+id,gradeItemTr:"table#mod_quiz-grade-item-list tr[data-quiz-grade-item-id]",inplaceEditable:"span.inplaceeditable",inplaceEditableOn:"span.inplaceeditable.inplaceeditingon",resetAllButton:"#mod_quiz-grades_reset_all",slotList:"table#mod_quiz-slot-list",updateGradeItemLink:id=>'tr[data-quiz-grade-item-id="'+id+'"] .quickeditlink'};const createGradeItem=quizId=>callServiceAndReturnRenderingData({methodname:"mod_quiz_create_grade_items",args:{quizid:quizId,quizgradeitems:[{name:""}]}});const updateGradeItem=(quizId,gradeItemId,newName)=>callServiceAndReturnRenderingData({methodname:"mod_quiz_update_grade_items",args:{quizid:quizId,quizgradeitems:[{id:gradeItemId,name:newName}]}});const deleteGradeItem=(quizId,gradeItemId)=>callServiceAndReturnRenderingData({methodname:"mod_quiz_delete_grade_items",args:{quizid:quizId,quizgradeitems:[{id:gradeItemId}]}});const updateSlotGradeItem=(quizId,slotId,gradeItemId)=>callServiceAndReturnRenderingData({methodname:"mod_quiz_update_slots",args:{quizid:quizId,slots:[{id:slotId,quizgradeitemid:gradeItemId}]}});const autoSetupGradeItems=quizId=>callServiceAndReturnRenderingData({methodname:"mod_quiz_create_grade_item_per_section",args:{quizid:quizId}});const callServiceAndReturnRenderingData=methodCall=>callServicesAndReturnRenderingData([methodCall]);const callServicesAndReturnRenderingData=methodCalls=>{methodCalls.push({methodname:"mod_quiz_get_edit_grading_page_data",args:{quizid:methodCalls[0].args.quizid}});return Promise.all(fetchMany(methodCalls)).then(results=>JSON.parse(results.at(-1)))};const handleGradeItemDelete=e=>{e.preventDefault();const pending=new Pending("delete-quiz-grade-item");const tableCell=e.target.closest("td");addIconToContainer(tableCell,pending);const tableRow=tableCell.closest("tr");const quizId=tableRow.closest("table").dataset.quizId;const gradeItemId=tableRow.dataset.quizGradeItemId;let nextItemToFocus;if(tableRow.nextElementSibling){nextItemToFocus=SELECTORS.updateGradeItemLink(tableRow.nextElementSibling.dataset.quizGradeItemId)}else{nextItemToFocus=SELECTORS.addGradeItemButton}deleteGradeItem(quizId,gradeItemId).then(reRenderPage).then(()=>{pending.resolve();document.querySelector(nextItemToFocus).focus()}).catch(Notification.exception)};const stopEditingGadeItem=editableSpan=>{editableSpan.innerHTML=editableSpan.dataset.oldContent;delete editableSpan.dataset.oldContent;editableSpan.classList.remove("inplaceeditingon");editableSpan.querySelector("[data-action-edit]").focus()};const handleGradeItemEditStart=e=>{e.preventDefault();const pending=new Pending("edit-quiz-grade-item-start");const editableSpan=e.target.closest(SELECTORS.inplaceEditable);document.querySelectorAll(SELECTORS.inplaceEditableOn).forEach(stopEditingGadeItem);editableSpan.dataset.oldContent=editableSpan.innerHTML;getString("edittitleinstructions").then(instructions=>{const uniqueId="gi-edit-input-"+editableSpan.closest("tr").dataset.quizGradeItemId;editableSpan.innerHTML='<span class="editinstructions">'+instructions+"</span>"+'<label class="sr-only" for="'+uniqueId+'">'+editableSpan.dataset.editLabel+"</label>"+'<input type="text" id="'+uniqueId+'" value="'+editableSpan.dataset.rawName+'" class="ignoredirty form-control w-100">';const inputElement=editableSpan.querySelector("input");inputElement.focus();inputElement.select();editableSpan.classList.add("inplaceeditingon");pending.resolve();return null}).catch(Notification.exception)};const handleGradeItemKeyDown=e=>{if(e.keyCode!==13){return}const editableSpan=e.target.closest(SELECTORS.inplaceEditableOn);if(!editableSpan||!editableSpan.closest(SELECTORS.gradeItemList)){return}e.preventDefault();const pending=new Pending("edit-quiz-grade-item-save");const newName=editableSpan.querySelector("input").value;const tableCell=e.target.closest("th");addIconToContainer(tableCell);const tableRow=tableCell.closest("tr");const quizId=tableRow.closest("table").dataset.quizId;const gradeItemId=tableRow.dataset.quizGradeItemId;updateGradeItem(quizId,gradeItemId,newName).then(reRenderPage).then(()=>{pending.resolve();document.querySelector(SELECTORS.updateGradeItemLink(gradeItemId)).focus({focusVisible:true})}).catch(Notification.exception)};const reRenderPage=editGradingPageData=>renderTemplate("mod_quiz/edit_grading_page",editGradingPageData).then((html,js)=>replaceNode(document.querySelector(SELECTORS.editingPageContents),html,js||""));const handleGradeItemKeyUp=e=>{if(e.keyCode!==27){return}const editableSpan=e.target.closest(SELECTORS.inplaceEditableOn);if(!editableSpan||!editableSpan.closest(SELECTORS.gradeItemList)){return}e.preventDefault();stopEditingGadeItem(editableSpan)};const handleGradeItemFocusOut=e=>{if(MoodleConfig.behatsiterunning){return}const editableSpan=e.target.closest(SELECTORS.inplaceEditableOn);if(!editableSpan||!editableSpan.closest(SELECTORS.gradeItemList)){return}e.preventDefault();stopEditingGadeItem(editableSpan)};const handleSlotGradeItemChanged=e=>{const select=e.target.closest(SELECTORS.gradeItemSelect);if(!select||!select.closest(SELECTORS.slotList)){return}e.preventDefault();const pending=new Pending("edit-slot-grade-item-updated");const slotId=select.dataset.slotId;const newGradeItemId=select.value?select.value:null;const tableCell=e.target.closest("td");addIconToContainer(tableCell,pending);const quizId=tableCell.closest("table").dataset.quizId;updateSlotGradeItem(quizId,slotId,newGradeItemId).then(reRenderPage).then(()=>{pending.resolve();document.querySelector(SELECTORS.gradeItemSelectId(slotId)).focus()}).catch(Notification.exception)};const handleGradeItemClick=e=>{const link=e.target.closest("a");if(!link||!link.closest(SELECTORS.gradeItemList)){return}if(link.dataset.actionDelete){handleGradeItemDelete(e)}if(link.dataset.actionEdit){handleGradeItemEditStart(e)}};const handleButtonClick=e=>{if(e.target.closest(SELECTORS.addGradeItemButton)){handleAddGradeItemClick(e)}if(e.target.closest(SELECTORS.autoSetupButton)){handleAutoSetup(e)}if(e.target.closest(SELECTORS.resetAllButton)){handleResetAllClick(e)}};const handleAddGradeItemClick=e=>{e.preventDefault();const pending=new Pending("create-quiz-grade-item");addIconToContainer(e.target.parentNode,pending);const quizId=e.target.dataset.quizId;createGradeItem(quizId).then(reRenderPage).then(()=>{pending.resolve();document.querySelector(SELECTORS.addGradeItemButton).focus()}).catch(Notification.exception)};const handleAutoSetup=e=>{e.preventDefault();const pending=new Pending("setup-quiz-grade-items");const quizId=e.target.dataset.quizId;autoSetupGradeItems(quizId).then(reRenderPage).then(()=>{pending.resolve();document.querySelector(SELECTORS.resetAllButton).focus()}).catch(Notification.exception)};const handleResetAllClick=e=>{e.preventDefault();const button=e.target;Notification.deleteCancelPromise(getString("gradeitemsremoveallconfirm","quiz"),getString("gradeitemsremoveallmessage","quiz"),getString("reset"),button).then(()=>reallyResetAll(button)).catch(()=>button.focus())};const reallyResetAll=button=>{const pending=new Pending("reset-quiz-grading");addIconToContainer(button.parentNode,pending);const quizId=button.dataset.quizId;let methodCalls=[];const slotResets=[...document.querySelectorAll(SELECTORS.gradeItemSelect)].map(select=>({id:select.dataset.slotId,quizgradeitemid:0}));if(slotResets.length){methodCalls.push({methodname:"mod_quiz_update_slots",args:{quizid:quizId,slots:slotResets}})}methodCalls.push({methodname:"mod_quiz_delete_grade_items",args:{quizid:quizId,quizgradeitems:[...document.querySelectorAll(SELECTORS.gradeItemTr)].map(tr=>{return{id:tr.dataset.quizGradeItemId}})}});callServicesAndReturnRenderingData(methodCalls).then(reRenderPage).then(()=>{pending.resolve();document.querySelector(SELECTORS.addGradeItemButton).focus()}).catch(Notification.exception)};const registerEventListeners=()=>{document.body.addEventListener("click",handleGradeItemClick);document.body.addEventListener("keydown",handleGradeItemKeyDown);document.body.addEventListener("keyup",handleGradeItemKeyUp);document.body.addEventListener("focusout",handleGradeItemFocusOut);document.body.addEventListener("click",handleButtonClick);document.body.addEventListener("change",handleSlotGradeItemChanged)};export const init=()=>{registerEventListeners()};