import $ from"jquery";import{createPopper}from"core/popper2";import CustomEvents from"core/custom_interaction_events";import Selectors from"forumreport_summary/selectors";import Ajax from"core/ajax";import KeyCodes from"core/key_codes";import*as FormChangeChecker from"core_form/changechecker";export const init=root=>{let jqRoot=$(root);$(document).ready(function(){$(".loading-icon").hide();$("#summaryreport").removeClass("hidden")});const generateWithFilters=(event,getparams)=>{let currentLink=document.forms.filtersform.action,newLink;if(event){event.preventDefault();let currentSplit=currentLink.split("?"),currentstring=currentSplit[1],newparamsarray=getparams.split("&"),paramsstring="",paramkeys=[],paramvalues=[];currentstring.split("&").forEach(function(param){let splitparam=param.split("=");paramkeys.push(splitparam[0]);paramvalues.push(splitparam[1])});newparamsarray.forEach(function(paramstring){let newparam=paramstring.split("="),existingkey=paramkeys.indexOf(newparam[0]);if(existingkey>-1){paramvalues[existingkey]=newparam[1]}else{paramkeys.push(newparam[0]);paramvalues.push(newparam[1])}});paramkeys.forEach(function(name,key){paramsstring+=`&${name}=${paramvalues[key]}`});newLink=currentSplit[0]+"?"+paramsstring.substr(1)}else{newLink=currentLink}document.forms.filtersform.action=newLink;document.forms.filtersform.submit()};$(".resettable").on("click","a",function(event){generateWithFilters(event,event.target.search.substr(1))});$("thead").on("click","a",function(event){generateWithFilters(event,event.target.search.substr(1))});$(".pagination").on("click","a",function(event){generateWithFilters(event,event.target.search.substr(1))});if(document.forms.selectperpage){document.forms.selectperpage.onsubmit=event=>{let getparam="perpage="+document.forms.selectperpage.elements.perpage.value;generateWithFilters(event,getparam)}}const downloadForm=document.getElementById("summaryreport").querySelector("form.dataformatselector");if(downloadForm){downloadForm.onsubmit=event=>{const downloadType=downloadForm.querySelector("#downloadtype_download").value;const getParams=`download=${downloadType}`;const prevAction=document.forms.filtersform.action;generateWithFilters(event,getParams);document.forms.filtersform.action=prevAction}}const submitWithFilter=containerelement=>{FormChangeChecker.unWatchForm(document.forms.filtersform);$(containerelement).addClass("hidden");generateWithFilters(false)};const updateCalendarPosition=referenceid=>{let referenceElement=document.querySelector(referenceid),popperContent=document.querySelector(Selectors.filters.date.calendar);popperContent.style.removeProperty("z-index");createPopper(referenceElement,popperContent,{placement:"bottom-end"})};const closeOpenFilters=(openFilterButton,openFilter)=>{openFilter.classList.add("hidden");openFilter.setAttribute("data-openfilter","false");openFilterButton.classList.add("btn-primary");openFilterButton.classList.remove("btn-outline-primary");openFilterButton.setAttribute("aria-expanded",false)};jqRoot.on(CustomEvents.events.activate,Selectors.filters.group.selectall,function(){let deselected=root.querySelectorAll(Selectors.filters.group.checkbox+":not(:checked)");deselected.forEach(function(checkbox){checkbox.checked=true})});jqRoot.on(CustomEvents.events.activate,Selectors.filters.group.clear,function(){let selected=root.querySelectorAll(Selectors.filters.group.checkbox+":checked");selected.forEach(function(checkbox){checkbox.checked=false})});jqRoot.on(CustomEvents.events.activate,Selectors.filters.group.trigger,function(){let referenceElement=root.querySelector(Selectors.filters.group.trigger),popperContent=root.querySelector(Selectors.filters.group.popover);createPopper(referenceElement,popperContent,{placement:"bottom-end"});popperContent.classList.remove("hidden");popperContent.setAttribute("data-openfilter","true");referenceElement.classList.add("btn-outline-primary");referenceElement.classList.remove("btn-primary");referenceElement.setAttribute("aria-expanded",true);const closeListener=e=>{if(e.target.id!==referenceElement.id&&popperContent!==e.target.closest('[data-openfilter="true"]')&&(typeof e.keyCode==="undefined"||e.keyCode===KeyCodes.enter||e.keyCode===KeyCodes.space)){closeOpenFilters(referenceElement,popperContent);document.removeEventListener("click",closeListener);document.removeEventListener("keyup",closeListener);document.removeEventListener("keyup",escCloseListener)}};document.addEventListener("click",closeListener);document.addEventListener("keyup",closeListener);const escCloseListener=e=>{if(e.keyCode===KeyCodes.escape){closeOpenFilters(referenceElement,popperContent);document.removeEventListener("keyup",escCloseListener);document.removeEventListener("click",closeListener)}};document.addEventListener("keyup",escCloseListener)});jqRoot.on(CustomEvents.events.activate,Selectors.filters.group.save,function(){let popcheckboxes=root.querySelectorAll(Selectors.filters.group.checkbox);popcheckboxes.forEach(function(popcheckbox){let filtersform=document.forms.filtersform,saveid=popcheckbox.getAttribute("data-saveid");filtersform.querySelector(`#${saveid}`).checked=popcheckbox.checked});submitWithFilter("#filter-groups-popover")});document.querySelectorAll(Selectors.filters.exportlink.link).forEach(function(exportbutton){exportbutton.addEventListener("click",function(event){document.forms.exportlinkform.action=event.target.dataset.url;document.forms.exportlinkform.submit()})});jqRoot.on(CustomEvents.events.activate,Selectors.filters.date.trigger,function(){let referenceElement=root.querySelector(Selectors.filters.date.trigger),popperContent=root.querySelector(Selectors.filters.date.popover);createPopper(referenceElement,popperContent,{placement:"bottom-end"});popperContent.classList.remove("hidden");popperContent.setAttribute("data-openfilter","true");popperContent.querySelector('[name="filterdatefrompopover[enabled]"]').focus();referenceElement.classList.add("btn-outline-primary");referenceElement.classList.remove("btn-primary");referenceElement.setAttribute("aria-expanded",true);const closeListener=e=>{if(e.target.id!==referenceElement.id&&popperContent!==e.target.closest('[data-openfilter="true"]')&&(typeof e.keyCode==="undefined"||e.keyCode===KeyCodes.enter||e.keyCode===KeyCodes.space)){closeOpenFilters(referenceElement,popperContent);document.removeEventListener("click",closeListener);document.removeEventListener("keyup",closeListener);document.removeEventListener("keyup",escCloseListener)}};document.addEventListener("click",closeListener);document.addEventListener("keyup",closeListener);const escCloseListener=e=>{if(e.keyCode===KeyCodes.escape){closeOpenFilters(referenceElement,popperContent);document.removeEventListener("keyup",escCloseListener);document.removeEventListener("click",closeListener)}};document.addEventListener("keyup",escCloseListener)});jqRoot.on(CustomEvents.events.activate,Selectors.filters.date.save,function(){let filtersForm=document.forms.filtersform;const datesPopover=root.querySelector(Selectors.filters.date.popover);const fromEnabled=datesPopover.querySelector('[name="filterdatefrompopover[enabled]"]').checked?1:0;const toEnabled=datesPopover.querySelector('[name="filterdatetopopover[enabled]"]').checked?1:0;if(!fromEnabled&&!toEnabled){filtersForm.elements["datefrom[timestamp]"].value=0;filtersForm.elements["datefrom[enabled]"].value=fromEnabled;filtersForm.elements["dateto[timestamp]"].value=0;filtersForm.elements["dateto[enabled]"].value=toEnabled;submitWithFilter("#filter-dates-popover")}else{let args={data:[]};if(fromEnabled){args.data.push({key:"from",year:datesPopover.querySelector('[name="filterdatefrompopover[year]"]').value,month:datesPopover.querySelector('[name="filterdatefrompopover[month]"]').value,day:datesPopover.querySelector('[name="filterdatefrompopover[day]"]').value,hour:0,minute:0})}if(toEnabled){args.data.push({key:"to",year:datesPopover.querySelector('[name="filterdatetopopover[year]"]').value,month:datesPopover.querySelector('[name="filterdatetopopover[month]"]').value,day:datesPopover.querySelector('[name="filterdatetopopover[day]"]').value,hour:23,minute:59})}const request={methodname:"core_calendar_get_timestamps",args:args};Ajax.call([request])[0].done(function(result){let fromTimestamp=0,toTimestamp=0;result.timestamps.forEach(function(data){if(data.key==="from"){fromTimestamp=data.timestamp}else if(data.key==="to"){toTimestamp=data.timestamp}});if(toTimestamp>0&&fromTimestamp>toTimestamp){const warningdiv=document.getElementById("dates-filter-warning");warningdiv.classList.remove("hidden");warningdiv.classList.add("d-block")}else{filtersForm.elements["datefrom[timestamp]"].value=fromTimestamp;filtersForm.elements["datefrom[enabled]"].value=fromEnabled;filtersForm.elements["dateto[timestamp]"].value=toTimestamp;filtersForm.elements["dateto[enabled]"].value=toEnabled;submitWithFilter("#filter-dates-popover")}})}});jqRoot.on(CustomEvents.events.activate,Selectors.filters.date.calendariconfrom,function(){updateCalendarPosition(Selectors.filters.date.calendariconfrom)});jqRoot.on(CustomEvents.events.activate,Selectors.filters.date.calendariconto,function(){updateCalendarPosition(Selectors.filters.date.calendariconto)})};